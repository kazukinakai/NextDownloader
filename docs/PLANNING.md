# NextDownloader プロジェクト計画書

## プロジェクト概要と目的

NextDownloaderは、Mac用の高性能HLS動画ダウンローダーです。Web上で再生されている動画（特にHLS形式やDASH形式）を高速かつ効率的にダウンロードするためのアプリケーションで、Chrome拡張機能とMacネイティブアプリを組み合わせたハイブリッド構成を採用しています。

### 主な目的
- HLS/MPEG-DASH動画の高速ダウンロードを実現する
- ユーザーフレンドリーなインターフェースを提供する
- 信頼性の高いダウンロード機能を実装する
- 合法的な個人利用（購入済みコンテンツの保存など）をサポートする

## アーキテクチャと技術スタック

### 全体アーキテクチャ
プロジェクトは以下の主要コンポーネントで構成されています：

1. **Rustコア**:
   - ダウンロードエンジンのコア機能
   - HLS/DASH解析と並列ダウンロード処理
   - 外部ツール（yt-dlp, aria2c, ffmpeg）の管理と連携
   - クロスプラットフォーム対応のための基盤

2. **Macネイティブアプリ（SwiftUI）**:
   - モダンなユーザーインターフェース
   - Rustコアとの連携（FFIを介したブリッジ）
   - 設定の永続化とユーザー設定管理
   - macOS固有機能との統合

3. **Chrome拡張**:
   - Webページ上の動画ストリームを検出
   - メディアURLとメタデータを抽出
   - Native Messaging APIを介したネイティブアプリとの通信
   - ブラウザのセッション情報を活用した認証済みコンテンツへのアクセス

### 技術スタック

#### コア機能
- **Rust**: 最新安定版 (1.75+)
  - tokio: 非同期ランタイム
  - reqwest: HTTPクライアント
  - serde: シリアライゼーション/デシリアライゼーション
  - clap: コマンドライン引数パーサー
  - thiserror/anyhow: エラー処理

#### ユーザーインターフェース
- **Macネイティブアプリ**: Swift 5.9+, SwiftUI
- **Chrome拡張**: JavaScript, HTML, CSS
- **将来的なクロスプラットフォームUI**: 
  - Tauri (Rust + Web技術)
  - または各プラットフォームネイティブUI

#### 外部ツール
- **yt-dlp**: 様々な動画サイトからの抽出エンジン
- **aria2c**: 並列ダウンロード用ツール
- **ffmpeg**: 動画処理・結合ツール

#### 開発ツール
- Rust toolchain (rustup, cargo)
- Xcode 15+ (Macアプリ開発用)
- Git

## ディレクトリ構造の概要

```
NextDownloader/
├── docs/                       # プロジェクトドキュメント
├── swift/                      # Swift/SwiftUIベースのMacアプリ（MVP1）
│   ├── Application/            # アプリケーション層
│   ├── ChromeExtension/        # Chrome拡張機能
│   ├── Common/                 # 共通コンポーネント
│   ├── Domain/                 # ドメイン層（エンティティ、リポジトリインターフェース、ユースケース）
│   │   ├── Entities/           # ドメインエンティティ
│   │   ├── Repositories/       # リポジトリインターフェース
│   │   └── UseCases/           # ユースケース
│   ├── Extensions/             # Swift拡張
│   ├── Infrastructure/         # インフラストラクチャ層
│   │   ├── Repositories/       # リポジトリ実装
│   │   ├── Services/           # サービス実装
│   │   └── Tools/              # 外部ツール連携
│   └── NextDownloader/         # メインアプリケーション
│       ├── Features/           # 機能モジュール
│       │   ├── Download/       # ダウンロード機能
│       │   └── Settings/       # 設定機能
│       ├── Models/             # アプリケーションモデル
│       ├── Resources/          # リソースファイル
│       ├── Services/           # アプリケーションサービス
│       └── Utils/              # ユーティリティ
├── core/                       # Rustベースのコアコンポーネント
│   └── src/                    # Rustソースコード
│       └── tools/              # 外部ツール連携
├── macos-app/                  # 新しいMacアプリ（Rustコア連携）
├── gui/                        # クロスプラットフォームGUI
└── cli/                        # コマンドラインインターフェース
```

## コーディング規約とスタイルガイド

### Swift/SwiftUI
- Swift API Design Guidelines に準拠
- MVVM (Model-View-ViewModel) アーキテクチャパターンを採用
- SwiftLint を使用したコード品質の維持
- クリーンアーキテクチャの原則に従い、レイヤー間の依存関係を管理

### Rust
- Rust 公式スタイルガイドに準拠
- `cargo fmt` と `cargo clippy` を使用したコード品質の維持
- エラー処理に `Result` と `Option` を適切に使用
- 非同期処理には `async/await` パターンを採用

### 共通
- 関数やメソッドは単一責任の原則に従う
- 適切なドキュメンテーションコメントを記述
- テスト可能な設計を心がける
- 1ファイルは500行を目安にモジュール化

## テスト方針

### 単体テスト
- Swift: XCTest フレームワークを使用
- Rust: 組み込みのテストフレームワークを使用
- モックとスタブを活用した依存関係の分離

### 統合テスト
- コンポーネント間の連携テスト
- 外部ツールとの連携テスト

### UI テスト
- SwiftUI の UI テスト
- ユーザーシナリオに基づいたテストケース

## デプロイメントフロー

### Mac アプリ (MVP1)
1. Xcode でビルド
2. コード署名と公証
3. DMG パッケージの作成
4. リリースノートの作成
5. GitHub Releases または独自サイトでの配布

### 将来的なクロスプラットフォーム対応
1. Rust コアのビルド
2. プラットフォーム固有のラッパーのビルド
3. プラットフォーム固有のパッケージング
4. 各プラットフォームのストアへの配布

## ロードマップとマイルストーン

### フェーズ1: Rustコアの開発
- [x] プロジェクト構造の設計
- [x] Rustコアの基本設計
- [ ] ダウンロードエンジンの実装
  - [x] HLS解析機能の実装
  - [x] 並列ダウンロード処理の実装
  - [x] エラーハンドリングとリトライ機構の実装
  - [ ] DASH解析機能の実装
- [x] 外部ツール連携の実装
  - [x] yt-dlpラッパーの実装
  - [x] aria2cラッパーの実装
  - [x] ffmpegラッパーの実装
  - [x] 外部ツール管理サービスの実装
- [ ] FFIインターフェースの実装

### フェーズ2: Macアプリ（SwiftUI）との連携
- [ ] Swift/Rustブリッジの実装
- [ ] SwiftUIインターフェースの実装
- [ ] Chrome拡張機能の実装
- [ ] Native Messaging APIの実装
- [ ] 初回リリース（MVP1: Mac版）

### フェーズ3: 機能拡張と最適化
- [ ] 高度なダウンロード設定
- [ ] パフォーマンス最適化
- [ ] メディア変換機能
- [ ] バッチ処理機能
- [ ] テスト拡充

### フェーズ4: クロスプラットフォーム対応
- [ ] Windows/Linux対応
- [ ] クロスプラットフォームGUIの実装（Tauriまたは各プラットフォームネイティブUI）
- [ ] プラットフォーム固有の最適化
- [ ] 各プラットフォーム向けパッケージングと配布
