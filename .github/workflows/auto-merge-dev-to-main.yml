name: Auto-merge dev to main

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç›®çš„ï¼š
# devãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’è‡ªå‹•çš„ã«mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã™ã‚‹CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# 1. devãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
# 2. æ¯æ—¥å®šæœŸå®Ÿè¡Œã§devâ†’mainã®åŒæœŸã‚’ç¶­æŒ
# 3. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

on:
  # devãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
  push:
    branches:
      - dev
  
  # æ¯æ—¥åˆå‰0æ™‚ã«å®Ÿè¡Œï¼ˆå®šæœŸçš„ãªãƒãƒ¼ã‚¸ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«
  workflow_dispatch:

# ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã®æ¨©é™è¨­å®š
permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Personal Access Tokenã‚’ä½¿ç”¨ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«è¨­å®šï¼‰
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: Check for conflicts
        id: check_conflicts
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ•ã‚§ãƒƒãƒ
          git fetch origin main
          
          # devã¨mainã®é–“ã«ç«¶åˆãŒãªã„ã‹ç¢ºèª
          if git merge-tree $(git merge-base origin/dev origin/main) origin/dev origin/main | grep -i 'conflict'; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®è§£æ±ºãŒå¿…è¦ã§ã™ã€‚"
            exit 1
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            echo "âœ… ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
          fi
      
      - name: Create Pull Request
        if: steps.check_conflicts.outputs.has_conflicts != 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto-merge dev to main"
          title: "ğŸ¤– è‡ªå‹•ãƒãƒ¼ã‚¸: dev â†’ main"
          body: |
            ## è‡ªå‹•ãƒãƒ¼ã‚¸ PR
            
            ã“ã®PRã¯ã€devãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰mainãƒ–ãƒ©ãƒ³ãƒã¸ã®å¤‰æ›´ã‚’è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã™ã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚
            
            ### ğŸ“ å¤‰æ›´å†…å®¹
            
            devãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã®å¤‰æ›´ã‚’mainãƒ–ãƒ©ãƒ³ãƒã«åæ˜ ã—ã¾ã™ã€‚
          branch: auto-merge-dev-to-main
          base: main
          delete-branch: true
      
      - name: Auto-approve PR
        if: steps.create_pr.outputs.pull-request-number
        uses: hmarr/auto-approve-action@v3
        with:
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Merge Pull Request
        if: steps.create_pr.outputs.pull-request-number
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_LABELS: ""
          MERGE_METHOD: "merge"
          MERGE_COMMIT_MESSAGE: "Auto-merge dev to main"
          MERGE_DELETE_BRANCH: "true"
          PULL_REQUEST: ${{ steps.create_pr.outputs.pull-request-number }}
